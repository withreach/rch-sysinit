---
- name: Check for gpg file
  ansible.builtin.stat:
    path: "/etc/apt/keyrings/{{ item.name }}.gpg"
  register: sysinit_gpg_files

- name: "Add GPG key for {{ ansible_distribution }}"
  ansible.builtin.apt_key:
    url: "{{ item.key_url }}"
    state: present
    keyring: "/etc/apt/keyrings/{{ item.name }}.gpg"
  when: sysinit_gpg_filesstat.exist is not defined or not sysinit_gpg_files.stat.exists

- name: Fix keyring permissions
  ansible.builtin.file:
    path: "/etc/apt/keyrings/{{ item.name }}.gpg"
    mode: a+r

- name: Add repository
  ansible.builtin.apt_repository:
    repo: "deb signed-by=/etc/apt/keyrings/{{ item.name }}.gpg {{ item.repo }}"
    state: present
    update_cache: true

- name: Install
  ansible.builtin.apt:
    pkg:
      - "{{ item.name }}"
